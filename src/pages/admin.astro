---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/Navbar.astro";
---

<Layout>
  <Navbar />
  <main class="mx-auto w-full max-w-6xl px-6 py-16">
    <section class="space-y-12">
      <div class="flex flex-wrap items-center justify-between gap-6">
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
            Admin Dashboard
          </p>
          <h1 class="mt-3 font-display text-3xl font-semibold text-white">
            Manage portfolio content with clarity.
          </h1>
          <p class="mt-3 max-w-2xl text-slate-300">
            Projects and blog entries are stored in D1. Media uploads will use R2.
          </p>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <button
            class="inline-flex items-center gap-2 rounded-full border border-slate-700 px-5 py-2 text-sm font-semibold text-slate-200"
            type="button"
            data-refresh
          >
            Refresh Data
            <iconify-icon icon="ph:arrows-clockwise-bold"></iconify-icon>
          </button>
        </div>
      </div>

      <div class="grid gap-6">
        <div class="rounded-3xl border border-slate-800 bg-slate-900/60 p-6 shadow-sm">
          <h2 class="font-display text-lg font-semibold text-white">Profile Assets</h2>
          <p class="mt-2 text-sm text-slate-400">
            Upload avatar, profile photo, and resume files (R2 storage planned).
          </p>
          <div class="mt-6 grid gap-4 sm:grid-cols-2">
            <form class="grid gap-3 rounded-2xl border border-slate-800 bg-slate-950/50 p-4" data-upload-form="avatar">
              <p class="text-sm font-semibold text-slate-200">Avatar</p>
              <input
                class="text-xs text-slate-300 file:mr-4 file:rounded-full file:border-0 file:bg-slate-100 file:px-3 file:py-1 file:text-xs file:font-semibold file:text-slate-900"
                type="file"
                name="file"
                accept="image/png,image/jpeg,image/webp"
              />
              <button
                class="rounded-full border border-slate-700 px-4 py-2 text-xs font-semibold text-slate-200"
                type="submit"
              >
                Upload avatar
              </button>
              <p class="text-xs text-slate-500" data-upload-status="avatar"></p>
              <p class="text-xs text-slate-500" data-asset-current="avatar"></p>
            </form>
            <form class="grid gap-3 rounded-2xl border border-slate-800 bg-slate-950/50 p-4" data-upload-form="photo">
              <p class="text-sm font-semibold text-slate-200">Profile photo</p>
              <input
                class="text-xs text-slate-300 file:mr-4 file:rounded-full file:border-0 file:bg-slate-100 file:px-3 file:py-1 file:text-xs file:font-semibold file:text-slate-900"
                type="file"
                name="file"
                accept="image/png,image/jpeg,image/webp"
              />
              <button
                class="rounded-full border border-slate-700 px-4 py-2 text-xs font-semibold text-slate-200"
                type="submit"
              >
                Upload photo
              </button>
              <p class="text-xs text-slate-500" data-upload-status="photo"></p>
              <p class="text-xs text-slate-500" data-asset-current="photo"></p>
            </form>
          </div>
          <form class="mt-4 grid gap-3 rounded-2xl border border-slate-800 bg-slate-950/50 p-4" data-upload-form="resume">
            <p class="text-sm font-semibold text-slate-200">Resume / CV</p>
            <input
              class="text-xs text-slate-300 file:mr-4 file:rounded-full file:border-0 file:bg-slate-100 file:px-3 file:py-1 file:text-xs file:font-semibold file:text-slate-900"
              type="file"
              name="file"
              accept=".pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
            />
            <button
              class="rounded-full border border-slate-700 px-4 py-2 text-xs font-semibold text-slate-200"
              type="submit"
            >
              Upload resume
            </button>
            <p class="text-xs text-slate-500" data-upload-status="resume"></p>
            <p class="text-xs text-slate-500" data-asset-current="resume"></p>
          </form>
          <form class="mt-4 grid gap-3 rounded-2xl border border-slate-800 bg-slate-950/50 p-4" data-summary-form>
            <p class="text-sm font-semibold text-slate-200">Profile Summary</p>
            <textarea
              class="min-h-[120px] rounded-xl border border-slate-700 bg-slate-950/80 px-4 py-2 text-sm text-slate-100 focus:border-slate-500 focus:outline-none"
              name="summary"
              rows="4"
            ></textarea>
            <button
              class="rounded-full border border-slate-700 px-4 py-2 text-xs font-semibold text-slate-200"
              type="submit"
            >
              Save summary
            </button>
            <p class="text-xs text-slate-500" data-summary-status></p>
          </form>
        </div>

        <div class="grid gap-6 lg:grid-cols-2">
          <div class="rounded-3xl border border-slate-800 bg-slate-900/60 p-6 shadow-sm">
            <h2 class="font-display text-lg font-semibold text-white">New Project</h2>
            <p class="mt-2 text-sm text-slate-400">
              Add or update a project entry in the portfolio.
            </p>
            <form class="mt-6 grid gap-4" data-project-form>
              <input type="hidden" name="id" />
              <div class="grid gap-2">
                <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500" for="project-name">
                  Name
                  <span class="ml-1 text-rose-400">*</span>
                </label>
                <input
                  class="rounded-xl border border-slate-700 bg-slate-950/80 px-4 py-2 text-sm text-slate-100 focus:border-slate-500 focus:outline-none"
                  id="project-name"
                  name="name"
                  required
                  type="text"
                />
              </div>
              <div class="grid gap-2">
                <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500" for="project-summary">
                  Description
                  <span class="ml-1 text-rose-400">*</span>
                </label>
                <textarea
                  class="min-h-[120px] rounded-xl border border-slate-700 bg-slate-950/80 px-4 py-2 text-sm text-slate-100 focus:border-slate-500 focus:outline-none"
                  id="project-summary"
                  name="summary"
                  required
                  rows="4"
                ></textarea>
              </div>
              <div class="grid gap-2">
                <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500" for="project-href">
                  GitHub Link
                </label>
                <input
                  class="rounded-xl border border-slate-700 bg-slate-950/80 px-4 py-2 text-sm text-slate-100 focus:border-slate-500 focus:outline-none"
                  id="project-href"
                  name="href"
                  type="url"
                />
              </div>
              <div class="grid gap-2">
                <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500" for="project-status">
                  Status
                </label>
                <select
                  class="rounded-xl border border-slate-700 bg-slate-950/80 px-4 py-2 text-sm text-slate-100 focus:border-slate-500 focus:outline-none"
                  id="project-status"
                  name="status"
                >
                  <option value="draft">Draft</option>
                  <option value="published">Published</option>
                </select>
              </div>
              <div class="flex flex-wrap gap-3">
                <button
                  class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-100 px-5 py-2 text-sm font-semibold text-slate-900"
                  type="submit"
                  data-project-submit
                >
                  Create Project
                  <iconify-icon icon="ph:plus-bold"></iconify-icon>
                </button>
                <button
                  class="inline-flex items-center justify-center gap-2 rounded-full border border-slate-700 px-5 py-2 text-sm font-semibold text-slate-200"
                  type="button"
                  data-project-reset
                >
                  Clear
                </button>
              </div>
              <p class="text-xs text-slate-500" data-project-status></p>
            </form>
          </div>

          <div class="rounded-3xl border border-slate-800 bg-slate-900/60 p-6 shadow-sm">
            <h2 class="font-display text-lg font-semibold text-white">New Blog Post</h2>
            <p class="mt-2 text-sm text-slate-400">
              Create or update a blog entry with content and metadata.
            </p>
            <form class="mt-6 grid gap-4" data-blog-form>
              <input type="hidden" name="id" />
              <div class="grid gap-2">
                <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500" for="blog-title">
                  Title
                  <span class="ml-1 text-rose-400">*</span>
                </label>
                <input
                  class="rounded-xl border border-slate-700 bg-slate-950/80 px-4 py-2 text-sm text-slate-100 focus:border-slate-500 focus:outline-none"
                  id="blog-title"
                  name="title"
                  required
                  type="text"
                />
              </div>
              <div class="grid gap-2">
                <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500" for="blog-summary">
                  Summary
                  <span class="ml-1 text-rose-400">*</span>
                </label>
                <textarea
                  class="min-h-[120px] rounded-xl border border-slate-700 bg-slate-950/80 px-4 py-2 text-sm text-slate-100 focus:border-slate-500 focus:outline-none"
                  id="blog-summary"
                  name="summary"
                  required
                  rows="4"
                ></textarea>
              </div>
              <div class="grid gap-2">
                <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500" for="blog-slug">
                  Slug
                  <span class="ml-1 text-rose-400">*</span>
                </label>
                <input
                  class="rounded-xl border border-slate-700 bg-slate-950/80 px-4 py-2 text-sm text-slate-100 focus:border-slate-500 focus:outline-none"
                  id="blog-slug"
                  name="slug"
                  required
                  type="text"
                />
              </div>
              <div class="grid gap-2">
                <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500" for="blog-author">
                  Author
                </label>
                <input
                  class="rounded-xl border border-slate-700 bg-slate-950/80 px-4 py-2 text-sm text-slate-100 focus:border-slate-500 focus:outline-none"
                  id="blog-author"
                  name="author"
                  type="text"
                />
              </div>
              <div class="grid gap-2">
                <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500" for="blog-date">
                  Date
                </label>
                <input
                  class="rounded-xl border border-slate-700 bg-slate-950/80 px-4 py-2 text-sm text-slate-100 focus:border-slate-500 focus:outline-none"
                  id="blog-date"
                  name="date"
                  type="date"
                />
              </div>
              <div class="grid gap-2">
                <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500" for="blog-reading">
                  Reading Time (minutes)
                </label>
                <input
                  class="rounded-xl border border-slate-700 bg-slate-950/80 px-4 py-2 text-sm text-slate-100 focus:border-slate-500 focus:outline-none"
                  id="blog-reading"
                  name="reading_time"
                  type="number"
                  min="1"
                />
              </div>
              <div class="grid gap-2">
                <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500" for="blog-content">
                  Content (Markdown)
                </label>
                <textarea
                  class="min-h-[160px] rounded-xl border border-slate-700 bg-slate-950/80 px-4 py-2 text-sm text-slate-100 focus:border-slate-500 focus:outline-none"
                  id="blog-content"
                  name="content"
                  rows="6"
                ></textarea>
              </div>
              <div class="rounded-2xl border border-slate-800 bg-slate-950/50 p-4">
                <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">
                  Markdown Preview
                </p>
                <div class="prose prose-invert mt-3 max-w-none text-slate-200" data-blog-preview>
                  Preview will appear here.
                </div>
              </div>
              <div class="grid gap-2">
                <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500" for="blog-status">
                  Status
                </label>
                <select
                  class="rounded-xl border border-slate-700 bg-slate-950/80 px-4 py-2 text-sm text-slate-100 focus:border-slate-500 focus:outline-none"
                  id="blog-status"
                  name="status"
                >
                  <option value="draft">Draft</option>
                  <option value="published">Published</option>
                </select>
              </div>
              <div class="flex flex-wrap gap-3">
                <button
                  class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-100 px-5 py-2 text-sm font-semibold text-slate-900"
                  type="submit"
                  data-blog-submit
                >
                  Create Blog Post
                  <iconify-icon icon="ph:plus-bold"></iconify-icon>
                </button>
                <button
                  class="inline-flex items-center justify-center gap-2 rounded-full border border-slate-700 px-5 py-2 text-sm font-semibold text-slate-200"
                  type="button"
                  data-blog-reset
                >
                  Clear
                </button>
              </div>
              <p class="text-xs text-slate-500" data-blog-status></p>
            </form>
          </div>
        </div>

        <div class="grid gap-6 lg:grid-cols-2">
          <div class="rounded-3xl border border-slate-800 bg-slate-900/60 p-6 shadow-sm">
            <h2 class="font-display text-lg font-semibold text-white">Tools</h2>
            <p class="mt-2 text-sm text-slate-400">
              Add tools with icons for the public tool stack.
            </p>
            <form class="mt-6 grid gap-4" data-tool-form>
              <input type="hidden" name="id" />
              <div class="grid gap-2">
                <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500" for="tool-name">
                  Name
                  <span class="ml-1 text-rose-400">*</span>
                </label>
                <input
                  class="rounded-xl border border-slate-700 bg-slate-950/80 px-4 py-2 text-sm text-slate-100 focus:border-slate-500 focus:outline-none"
                  id="tool-name"
                  name="name"
                  required
                  type="text"
                />
              </div>
              <div class="grid gap-2">
                <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500" for="tool-icon">
                  Icon
                  <span class="ml-1 text-rose-400">*</span>
                </label>
                <select
                  class="rounded-xl border border-slate-700 bg-slate-950/80 px-4 py-2 text-sm text-slate-100 focus:border-slate-500 focus:outline-none"
                  id="tool-icon"
                  name="icon"
                >
                  <option value="logos:aws">AWS</option>
                  <option value="logos:google-cloud">Google Cloud</option>
                  <option value="logos:docker-icon">Docker</option>
                  <option value="logos:kubernetes">Kubernetes</option>
                  <option value="logos:terraform-icon">Terraform</option>
                  <option value="logos:github-actions">GitHub Actions</option>
                  <option value="logos:prometheus">Prometheus</option>
                  <option value="logos:grafana">Grafana</option>
                  <option value="logos:linux-tux">Linux</option>
                </select>
              </div>
              <div class="grid gap-2">
                <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500" for="tool-status">
                  Status
                </label>
                <select
                  class="rounded-xl border border-slate-700 bg-slate-950/80 px-4 py-2 text-sm text-slate-100 focus:border-slate-500 focus:outline-none"
                  id="tool-status"
                  name="status"
                >
                  <option value="draft">Draft</option>
                  <option value="published">Published</option>
                </select>
              </div>
              <div class="flex flex-wrap gap-3">
                <button
                  class="inline-flex items-center justify-center gap-2 rounded-full bg-slate-100 px-5 py-2 text-sm font-semibold text-slate-900"
                  type="submit"
                  data-tool-submit
                >
                  Create Tool
                  <iconify-icon icon="ph:plus-bold"></iconify-icon>
                </button>
                <button
                  class="inline-flex items-center justify-center gap-2 rounded-full border border-slate-700 px-5 py-2 text-sm font-semibold text-slate-200"
                  type="button"
                  data-tool-reset
                >
                  Clear
                </button>
              </div>
              <p class="text-xs text-slate-500" data-tool-status></p>
            </form>
          </div>

          <div class="rounded-3xl border border-slate-800 bg-slate-900/60 p-6 shadow-sm">
            <h2 class="font-display text-lg font-semibold text-white">Tools List</h2>
            <div class="mt-3 flex items-center gap-3 text-xs text-slate-400">
              <span>Status</span>
              <select
                class="rounded-full border border-slate-700 bg-slate-950/80 px-3 py-1 text-xs text-slate-200"
                data-tool-filter
              >
                <option value="all">All</option>
                <option value="draft">Draft</option>
                <option value="published">Published</option>
              </select>
            </div>
            <div class="mt-5 overflow-hidden rounded-2xl border border-slate-800">
              <div class="grid grid-cols-[1.2fr_0.8fr_0.6fr_0.5fr] gap-4 bg-slate-900/80 px-4 py-3 text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">
                <span>Name</span>
                <span>Icon</span>
                <span>Status</span>
                <span>Actions</span>
              </div>
              <div class="divide-y divide-slate-800" data-tool-list>
                <div class="px-4 py-4 text-sm text-slate-500">Loading...</div>
              </div>
            </div>
          </div>
        </div>

        <div class="grid gap-6 lg:grid-cols-2">
          <div class="rounded-3xl border border-slate-800 bg-slate-900/60 p-6 shadow-sm">
            <h2 class="font-display text-lg font-semibold text-white">Projects</h2>
            <div class="mt-3 flex items-center gap-3 text-xs text-slate-400">
              <span>Status</span>
              <select
                class="rounded-full border border-slate-700 bg-slate-950/80 px-3 py-1 text-xs text-slate-200"
                data-project-filter
              >
                <option value="all">All</option>
                <option value="draft">Draft</option>
                <option value="published">Published</option>
              </select>
            </div>
            <div class="mt-5 overflow-hidden rounded-2xl border border-slate-800">
              <div class="grid grid-cols-[1.4fr_0.7fr_0.6fr_0.5fr] gap-4 bg-slate-900/80 px-4 py-3 text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">
                <span>Title</span>
                <span>Status</span>
                <span>Updated</span>
                <span>Actions</span>
              </div>
              <div class="divide-y divide-slate-800" data-project-list>
                <div class="px-4 py-4 text-sm text-slate-500">Loading...</div>
              </div>
            </div>
          </div>

          <div class="rounded-3xl border border-slate-800 bg-slate-900/60 p-6 shadow-sm">
            <h2 class="font-display text-lg font-semibold text-white">Blog Posts</h2>
            <div class="mt-3 flex items-center gap-3 text-xs text-slate-400">
              <span>Status</span>
              <select
                class="rounded-full border border-slate-700 bg-slate-950/80 px-3 py-1 text-xs text-slate-200"
                data-blog-filter
              >
                <option value="all">All</option>
                <option value="draft">Draft</option>
                <option value="published">Published</option>
              </select>
            </div>
            <div class="mt-5 overflow-hidden rounded-2xl border border-slate-800">
              <div class="grid grid-cols-[1.4fr_0.7fr_0.6fr_0.5fr] gap-4 bg-slate-900/80 px-4 py-3 text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">
                <span>Title</span>
                <span>Status</span>
                <span>Updated</span>
                <span>Actions</span>
              </div>
              <div class="divide-y divide-slate-800" data-blog-list>
                <div class="px-4 py-4 text-sm text-slate-500">Loading...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
  <script type="module">
    import { marked } from "marked";
    const projectList = document.querySelector("[data-project-list]");
    const blogList = document.querySelector("[data-blog-list]");
    const refreshButton = document.querySelector("[data-refresh]");
    const projectForm = document.querySelector("[data-project-form]");
    const blogForm = document.querySelector("[data-blog-form]");
    const projectStatus = document.querySelector("[data-project-status]");
    const blogStatus = document.querySelector("[data-blog-status]");
    const projectReset = document.querySelector("[data-project-reset]");
    const blogReset = document.querySelector("[data-blog-reset]");
    const projectSubmit = document.querySelector("[data-project-submit]");
    const blogSubmit = document.querySelector("[data-blog-submit]");
    const blogPreview = document.querySelector("[data-blog-preview]");
    const toolList = document.querySelector("[data-tool-list]");
    const toolForm = document.querySelector("[data-tool-form]");
    const toolStatus = document.querySelector("[data-tool-status]");
    const toolReset = document.querySelector("[data-tool-reset]");
    const toolSubmit = document.querySelector("[data-tool-submit]");
    const projectFilter = document.querySelector("[data-project-filter]");
    const blogFilter = document.querySelector("[data-blog-filter]");
    const toolFilter = document.querySelector("[data-tool-filter]");
    const uploadForms = document.querySelectorAll("[data-upload-form]");
    const summaryForm = document.querySelector("[data-summary-form]");
    const summaryStatus = document.querySelector("[data-summary-status]");
    const assetCurrent = {
      avatar: document.querySelector("[data-asset-current='avatar']"),
      photo: document.querySelector("[data-asset-current='photo']"),
      resume: document.querySelector("[data-asset-current='resume']"),
    };

    const formatDate = (value) => {
      if (!value) return "-";
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return value;
      return date.toLocaleDateString(undefined, {
        year: "numeric",
        month: "short",
        day: "2-digit",
      });
    };

    const renderRows = (items, target, type) => {
      if (!target) return;
      if (!items.length) {
        target.innerHTML = '<div class="px-4 py-4 text-sm text-slate-500">No entries yet.</div>';
        return;
      }

      target.innerHTML = items
        .map((item) => {
          const title = item.name || item.title;
          return `
            <div class="grid grid-cols-[1.4fr_0.7fr_0.6fr_0.5fr] gap-4 px-4 py-4 text-sm">
              <span class="font-semibold text-white">${title}</span>
              <span class="text-slate-300">${item.status ?? "draft"}</span>
              <span class="text-slate-500">${formatDate(item.updated_at || item.created_at)}</span>
              <div class="flex flex-wrap gap-2">
                <button class="rounded-full border border-slate-700 px-3 py-1 text-xs font-semibold text-slate-200" data-edit data-type="${type}" data-id="${item.id}">
                  Edit
                </button>
                <button class="rounded-full border border-rose-500/40 px-3 py-1 text-xs font-semibold text-rose-300" data-delete data-type="${type}" data-id="${item.id}">
                  Delete
                </button>
              </div>
            </div>
          `;
        })
        .join("");
    };

    const renderTools = (items) => {
      if (!toolList) return;
      if (!items.length) {
        toolList.innerHTML = '<div class="px-4 py-4 text-sm text-slate-500">No entries yet.</div>';
        return;
      }

      toolList.innerHTML = items
        .map((item) => {
          return `
            <div class="grid grid-cols-[1.2fr_0.8fr_0.6fr_0.5fr] gap-4 px-4 py-4 text-sm">
              <span class="font-semibold text-white">${item.name}</span>
              <span class="text-slate-300">${item.icon}</span>
              <span class="text-slate-300">${item.status ?? "draft"}</span>
              <div class="flex flex-wrap gap-2">
                <button class="rounded-full border border-slate-700 px-3 py-1 text-xs font-semibold text-slate-200" data-edit data-type="tool" data-id="${item.id}">
                  Edit
                </button>
                <button class="rounded-full border border-rose-500/40 px-3 py-1 text-xs font-semibold text-rose-300" data-delete data-type="tool" data-id="${item.id}">
                  Delete
                </button>
              </div>
            </div>
          `;
        })
        .join("");
    };

    const filterItems = (items, filterValue) => {
      if (!filterValue || filterValue === "all") return items;
      return items.filter((item) => item.status === filterValue);
    };

    const fetchData = async () => {
      try {
        const [projectsResponse, blogsResponse, toolsResponse] = await Promise.all([
          fetch("/api/projects"),
          fetch("/api/blogs"),
          fetch("/api/tools"),
        ]);

        const projectsJson = await projectsResponse.json();
        const blogsJson = await blogsResponse.json();
        const toolsJson = await toolsResponse.json();

        const projects = projectsJson.data ?? [];
        const blogs = blogsJson.data ?? [];
        const tools = toolsJson.data ?? [];

        renderRows(filterItems(projects, projectFilter?.value), projectList, "project");
        renderRows(filterItems(blogs, blogFilter?.value), blogList, "blog");
        renderTools(filterItems(tools, toolFilter?.value));
      } catch (error) {
        if (projectList) {
          projectList.innerHTML = '<div class="px-4 py-4 text-sm text-rose-400">Failed to load.</div>';
        }
        if (blogList) {
          blogList.innerHTML = '<div class="px-4 py-4 text-sm text-rose-400">Failed to load.</div>';
        }
        if (toolList) {
          toolList.innerHTML = '<div class="px-4 py-4 text-sm text-rose-400">Failed to load.</div>';
        }
      }
    };

    const setStatus = (el, message, isError) => {
      if (!el) return;
      el.textContent = message;
      el.className = `text-xs ${isError ? "text-rose-400" : "text-slate-500"}`;
    };

    const resetForm = (form, submitButton, statusEl, defaultLabel) => {
      form.reset();
      form.querySelector("input[name='id']").value = "";
      submitButton.innerHTML = `${defaultLabel} <iconify-icon icon=\"ph:plus-bold\"></iconify-icon>`;
      setStatus(statusEl, "", false);
    };

    const handleSubmit = async (form, endpoint, statusEl, submitButton, defaultLabel, mapPayload) => {
      if (!form) return;
      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        setStatus(statusEl, "Saving...", false);

        const formData = new FormData(form);
        const payload = mapPayload(formData);
        const id = formData.get("id");
        const url = id ? `${endpoint}/${id}` : endpoint;
        const method = id ? "PUT" : "POST";

        try {
          const response = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            throw new Error("Request failed");
          }

          resetForm(form, submitButton, statusEl, defaultLabel);
          setStatus(statusEl, id ? "Updated." : "Created.", false);
          await fetchData();
        } catch (error) {
          setStatus(statusEl, "Failed to save.", true);
        }
      });
    };

    const findItem = (items, id) => items.find((item) => String(item.id) === String(id));

    const attachRowHandlers = (items, form, submitButton, statusEl, defaultLabel, type) => {
      if (!form) return;
      const inputId = form.querySelector("input[name='id']");

      return (event) => {
        const target = event.target.closest("button");
        if (!target) return;
        const id = target.dataset.id;
        const actionType = target.dataset.type;
        if (actionType !== type) return;

        if (target.hasAttribute("data-edit")) {
          const item = findItem(items, id);
          if (!item) return;
          inputId.value = item.id;
          if (type === "project") {
            form.querySelector("#project-name").value = item.name ?? "";
            form.querySelector("#project-summary").value = item.summary ?? "";
            form.querySelector("#project-href").value = item.href ?? "";
            form.querySelector("#project-status").value = item.status ?? "draft";
          } else if (type === "blog") {
            form.querySelector("#blog-title").value = item.title ?? "";
            form.querySelector("#blog-summary").value = item.summary ?? "";
            form.querySelector("#blog-slug").value = item.slug ?? "";
            form.querySelector("#blog-author").value = item.author ?? "";
            form.querySelector("#blog-date").value = item.date ?? "";
            form.querySelector("#blog-reading").value = item.reading_time ?? "";
            form.querySelector("#blog-content").value = item.content ?? "";
            form.querySelector("#blog-status").value = item.status ?? "draft";
            renderBlogPreview();
          } else {
            form.querySelector("#tool-name").value = item.name ?? "";
            form.querySelector("#tool-icon").value = item.icon ?? "logos:aws";
            form.querySelector("#tool-status").value = item.status ?? "draft";
          }

          submitButton.innerHTML = `Update ${type === "project" ? "Project" : type === "blog" ? "Blog" : "Tool"} <iconify-icon icon=\"ph:check-bold\"></iconify-icon>`;
          setStatus(statusEl, "Editing mode.", false);
        }
      };
    };

    const handleDelete = async (id, type) => {
      const confirmDelete = window.confirm("Delete this entry?");
      if (!confirmDelete) return;
      try {
        const response = await fetch(`/api/${type}s/${id}`, { method: "DELETE" });
        if (!response.ok) {
          throw new Error("Request failed");
        }
        await fetchData();
      } catch (error) {
        window.alert("Failed to delete entry.");
      }
    };

    handleSubmit(
      projectForm,
      "/api/projects",
      projectStatus,
      projectSubmit,
      "Create Project",
      (formData) => ({
        name: formData.get("name"),
        summary: formData.get("summary"),
        href: formData.get("href") || null,
        status: formData.get("status") || "draft",
      })
    );

    handleSubmit(
      blogForm,
      "/api/blogs",
      blogStatus,
      blogSubmit,
      "Create Blog Post",
      (formData) => ({
        title: formData.get("title"),
        summary: formData.get("summary"),
        slug: formData.get("slug"),
        author: formData.get("author") || null,
        date: formData.get("date") || null,
        reading_time: formData.get("reading_time")
          ? Number(formData.get("reading_time"))
          : null,
        content: formData.get("content") || null,
        status: formData.get("status") || "draft",
      })
    );

    handleSubmit(
      toolForm,
      "/api/tools",
      toolStatus,
      toolSubmit,
      "Create Tool",
      (formData) => ({
        name: formData.get("name"),
        icon: formData.get("icon"),
        status: formData.get("status") || "draft",
      })
    );

    if (projectReset && projectForm && projectSubmit) {
      projectReset.addEventListener("click", () =>
        resetForm(projectForm, projectSubmit, projectStatus, "Create Project")
      );
    }

    if (blogReset && blogForm && blogSubmit) {
      blogReset.addEventListener("click", () =>
        resetForm(blogForm, blogSubmit, blogStatus, "Create Blog Post")
      );
    }

    if (toolReset && toolForm && toolSubmit) {
      toolReset.addEventListener("click", () =>
        resetForm(toolForm, toolSubmit, toolStatus, "Create Tool")
      );
    }

    if (refreshButton) {
      refreshButton.addEventListener("click", fetchData);
    }

    const bindListHandlers = (target, type, form, submitButton, statusEl, defaultLabel, items) => {
      if (!target) return;
      target.addEventListener("click", async (event) => {
        const button = event.target.closest("button");
        if (!button) return;
        const id = button.dataset.id;
        if (!id) return;
        if (button.hasAttribute("data-delete")) {
          await handleDelete(id, type);
          return;
        }
        if (button.hasAttribute("data-edit")) {
          const handler = attachRowHandlers(items, form, submitButton, statusEl, defaultLabel, type);
          handler?.(event);
        }
      });
    };

    const fetchAndBind = async () => {
      try {
        const [projectsResponse, blogsResponse, toolsResponse] = await Promise.all([
          fetch("/api/projects"),
          fetch("/api/blogs"),
          fetch("/api/tools"),
        ]);

        const projectsJson = await projectsResponse.json();
        const blogsJson = await blogsResponse.json();
        const toolsJson = await toolsResponse.json();
        const projects = projectsJson.data ?? [];
        const blogs = blogsJson.data ?? [];
        const tools = toolsJson.data ?? [];

        renderRows(filterItems(projects, projectFilter?.value), projectList, "project");
        renderRows(filterItems(blogs, blogFilter?.value), blogList, "blog");
        renderTools(filterItems(tools, toolFilter?.value));

        bindListHandlers(
          projectList,
          "project",
          projectForm,
          projectSubmit,
          projectStatus,
          "Create Project",
          projects
        );
        bindListHandlers(
          blogList,
          "blog",
          blogForm,
          blogSubmit,
          blogStatus,
          "Create Blog Post",
          blogs
        );
        bindListHandlers(
          toolList,
          "tool",
          toolForm,
          toolSubmit,
          toolStatus,
          "Create Tool",
          tools
        );

        if (projectFilter) {
          projectFilter.onchange = () =>
            renderRows(filterItems(projects, projectFilter.value), projectList, "project");
        }
        if (blogFilter) {
          blogFilter.onchange = () =>
            renderRows(filterItems(blogs, blogFilter.value), blogList, "blog");
        }
        if (toolFilter) {
          toolFilter.onchange = () => renderTools(filterItems(tools, toolFilter.value));
        }
      } catch (error) {
        if (projectList) {
          projectList.innerHTML = '<div class="px-4 py-4 text-sm text-rose-400">Failed to load.</div>';
        }
        if (blogList) {
          blogList.innerHTML = '<div class="px-4 py-4 text-sm text-rose-400">Failed to load.</div>';
        }
        if (toolList) {
          toolList.innerHTML = '<div class="px-4 py-4 text-sm text-rose-400">Failed to load.</div>';
        }
      }
    };

    const updateAssetText = (type, key) => {
      const el = assetCurrent[type];
      if (!el) return;
      el.textContent = key ? `Current: ${key}` : "No file uploaded yet.";
    };

    const fetchProfileAssets = async () => {
      try {
        const response = await fetch("/api/profile-assets");
        if (!response.ok) throw new Error("Failed");
        const json = await response.json();
        const data = json.data ?? {};
        updateAssetText("avatar", data.avatar_key);
        updateAssetText("photo", data.photo_key);
        updateAssetText("resume", data.resume_key);
        if (summaryForm) {
          const textarea = summaryForm.querySelector("textarea[name='summary']");
          if (textarea) textarea.value = data.summary ?? "";
        }
      } catch (error) {
        updateAssetText("avatar", null);
        updateAssetText("photo", null);
        updateAssetText("resume", null);
      }
    };

    const saveProfileAsset = async (type, key) => {
      const payload = {};
      if (type === "avatar") payload.avatar_key = key;
      if (type === "photo") payload.photo_key = key;
      if (type === "resume") payload.resume_key = key;
      await fetch("/api/profile-assets", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
    };

    const bindUploads = () => {
      uploadForms.forEach((form) => {
        form.addEventListener("submit", async (event) => {
          event.preventDefault();
          const type = form.dataset.uploadForm;
          const statusEl = form.querySelector(`[data-upload-status='${type}']`);
          const input = form.querySelector("input[type='file']");
          if (!input || !input.files || input.files.length === 0) {
            if (statusEl) statusEl.textContent = "Select a file first.";
            return;
          }

          if (statusEl) statusEl.textContent = "Uploading...";

          const formData = new FormData();
          formData.append("file", input.files[0]);

          try {
            const response = await fetch(`/api/uploads/${type}`, {
              method: "POST",
              body: formData,
            });

            if (!response.ok) {
              throw new Error("Upload failed");
            }

            const json = await response.json();
            if (statusEl) statusEl.textContent = `Uploaded: ${json.key ?? "ok"}`;
            if (json.key) {
              await saveProfileAsset(type, json.key);
              updateAssetText(type, json.key);
            }
            input.value = "";
          } catch (error) {
            if (statusEl) statusEl.textContent = "Upload failed.";
          }
        });
      });
    };

    const bindSummary = () => {
      if (!summaryForm) return;
      summaryForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (summaryStatus) summaryStatus.textContent = "Saving...";
        const textarea = summaryForm.querySelector("textarea[name='summary']");
        const summary = textarea ? textarea.value : "";
        try {
          const response = await fetch("/api/profile-assets", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ summary }),
          });
          if (!response.ok) throw new Error("Failed");
          if (summaryStatus) summaryStatus.textContent = "Saved.";
        } catch (error) {
          if (summaryStatus) summaryStatus.textContent = "Failed to save.";
        }
      });
    };

    let renderBlogPreview = () => {};

    const bindMarkdownPreview = () => {
      if (!blogPreview || !blogForm) return;
      const textarea = blogForm.querySelector("#blog-content");
      if (!textarea) return;

      const render = () => {
        const value = textarea.value || "";
        blogPreview.innerHTML = value ? marked.parse(value) : "Preview will appear here.";
      };

      renderBlogPreview = render;
      textarea.addEventListener("input", render);
      render();
    };

    bindUploads();
    bindSummary();
    bindMarkdownPreview();
    fetchAndBind();
    fetchProfileAssets();
  </script>
</Layout>
