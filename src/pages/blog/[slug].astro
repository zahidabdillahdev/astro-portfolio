---
import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/Navbar.astro";
import Footer from "../../components/Footer.astro";
import DOMPurify from "isomorphic-dompurify";
import { marked } from "marked";

export const prerender = false;

const slug = Astro.params.slug;
const apiUrl = new URL("/data/blogs", Astro.request.url);
const response = await fetch(apiUrl);
const data = response.ok ? await response.json() : { data: [] };
const post = (data.data ?? []).find((item) => item.slug === slug) ?? null;
const title = post?.title ?? "Post not found";
const description = post?.summary ?? "Blog post";
const rawContent = post?.content ?? "";
const rawHtml = marked.parse(rawContent, { mangle: false, headerIds: true });
const safeHtml = DOMPurify.sanitize(rawHtml);
const publishedDate = post?.date ?? post?.updated_at ?? "";
---

<Layout title={title} description={description}>
  <Navbar />
  <main class="mx-auto w-full max-w-4xl px-6 py-16">
    <article class="rounded-3xl border border-slate-800 bg-slate-900/60 p-8 shadow-sm">
      <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
        {publishedDate
          ? new Date(publishedDate).toLocaleDateString(undefined, {
              year: "numeric",
              month: "long",
              day: "2-digit",
            })
          : "Post not found"}
      </p>
      <h1 class="mt-4 font-display text-4xl font-semibold text-white">
        {title}
      </h1>
      <div class="mt-3 flex flex-wrap gap-3 text-sm text-slate-400">
        {post?.author && <span>{post.author}</span>}
        {post?.reading_time && <span>{post.reading_time} min read</span>}
      </div>
      <div class="prose prose-invert mt-8 max-w-none text-slate-200" set:html={safeHtml} />
    </article>
  </main>
  <Footer />
</Layout>
