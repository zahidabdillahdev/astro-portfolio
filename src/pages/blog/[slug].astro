---
import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/Navbar.astro";
import Footer from "../../components/Footer.astro";

export const prerender = false;
---

<Layout>
  <Navbar />
  <main class="mx-auto w-full max-w-4xl px-6 py-16">
    <article class="rounded-3xl border border-slate-800 bg-slate-900/60 p-8 shadow-sm">
      <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500" data-post-date>
        Loading...
      </p>
      <h1 class="mt-4 font-display text-4xl font-semibold text-white" data-post-title>
        Loading post
      </h1>
      <div class="mt-3 flex flex-wrap gap-3 text-sm text-slate-400" data-post-meta></div>
      <div class="prose prose-invert mt-8 max-w-none text-slate-200" data-post-content>
        <p>Post content will appear here.</p>
      </div>
    </article>
  </main>
  <Footer />

  <script type="module">
    import { marked } from "marked";
    import DOMPurify from "dompurify";

    const titleEl = document.querySelector("[data-post-title]");
    const dateEl = document.querySelector("[data-post-date]");
    const metaEl = document.querySelector("[data-post-meta]");
    const contentEl = document.querySelector("[data-post-content]");
    const slug = window.location.pathname.split("/").filter(Boolean).pop();

    const formatDate = (value) => {
      if (!value) return "-";
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return value;
      return date.toLocaleDateString(undefined, {
        year: "numeric",
        month: "long",
        day: "2-digit",
      });
    };

    const loadPost = async () => {
      try {
        const response = await fetch("/data/blogs");
        if (!response.ok) throw new Error("Failed");
        const json = await response.json();
        const post = (json.data ?? []).find((item) => item.slug === slug);

        if (!post) {
          if (titleEl) titleEl.textContent = "Post not found";
          if (dateEl) dateEl.textContent = "";
          if (contentEl) contentEl.innerHTML = "<p>We could not find this post.</p>";
          return;
        }

        if (titleEl) titleEl.textContent = post.title ?? "Untitled post";
        if (dateEl) dateEl.textContent = formatDate(post.date ?? post.updated_at);
        if (metaEl) {
          metaEl.innerHTML = "";
          if (post.author) {
            const author = document.createElement("span");
            author.textContent = post.author;
            metaEl.append(author);
          }
          if (post.reading_time) {
            const reading = document.createElement("span");
            reading.textContent = `${post.reading_time} min read`;
            metaEl.append(reading);
          }
        }

        if (contentEl) {
          const markdown = post.content || "";
          const raw = marked.parse(markdown, { mangle: false, headerIds: false });
          contentEl.innerHTML = DOMPurify.sanitize(raw);
        }
      } catch (error) {
        if (titleEl) titleEl.textContent = "Unable to load post";
      }
    };

    loadPost();
  </script>
</Layout>
